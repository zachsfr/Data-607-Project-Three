---
title: "TableMaker"
author: "EH"
date: "3/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
```

## Make sure xls tables parse correctly into data.frames  

```{r}
degrees <- read_excel('tables/DegreeKeys.xlsx')
skills <- read_excel('tables/SkillKeys.xlsx')
listings <- read_excel('tables/Listings.xlsx')
head(listings, 1)
setwd("/Users/ethanhaley/collab/Proj3collab/Data-607-Project-Three")
```

```{r}
mins <- listings$MinSkills
nices <- listings$NiceSkills
# initialize table with first listing
# join minimum skills and nice to have skills
p <- paste(as.vector(mins[1]), as.vector(nices[1]), sep = ',')
# remove duplicates
u <- unique(strsplit(p,','))
table <- data.frame(1, u)
names(table) = c('listing', 'skill')
table[1:5,]
```

```{r}
# now add for all the rest of the listings
for (i in 2:length(mins)) {
  p <- paste(as.vector(mins[i]), as.vector(nices[i]), sep = ',')
  u <- unique(strsplit(p,','))
  t <- data.frame(i, u)
  names(t) = c('listing', 'skill')
  table <- rbind(table, t)
}
tail(table)
```

```{r}
companies <- listings[c("Company", "Size")] %>%
  unique()
companies$id <- c(1:nrow(companies))  
head(companies)
```
### Replace Company names in listings table with ID from this new companies table

```{r}
ids <- sapply(listings$Company, function(c){as.numeric(companies[companies$Company == c, "id"])})
length(ids)
```

```{r}
listings$comp_id <- ids
listings$list_id <- c(1:length(ids))
head(listings)
```
##### reorder the listings columns

```{r}
listings <- listings[c('list_id', 'comp_id', 'Level', 'Title', 'Keywords',
                       'MinYrs', 'NiceYrs', 'Degree', 'STEM', 'City', 'State',
                       'MinSal', 'MaxSal')]
head(listings, 1)
```

# Use the MariaDB syntax to build the schema and make the database

```{r}
library(RMariaDB)
mariacon <- dbConnect(RMariaDB::MariaDB(), dbname = 'PROJ3', username = "xxxx",
                   password = "xxxxxxx", host = "xxxxxxxxx",
                   port = xxxx)
```

### Start with the tables with no foreign keys, so that nothing is pre-referenced.  
**Skills table**
```{sql connection='mariacon'}

CREATE TABLE IF NOT EXISTS `Skills`
(
`code` VARCHAR(50) NOT NULL,
`meaning` VARCHAR(50) NOT NULL,
PRIMARY KEY(`code`)
);
```

**Degrees table**
```{sql connection='mariacon'}
CREATE TABLE IF NOT EXISTS `Degrees`
(
`degreeLevel` INT NOT NULL,
`meaning` VARCHAR(50) NOT NULL, 
PRIMARY KEY(`degreeLevel`)
);
```

**Companies table**
```{sql connection='mariacon'}
CREATE TABLE IF NOT EXISTS  `Companies`
(
`id` INT NOT NULL,
`name` VARCHAR(50) NOT NULL,
`numEmpls` INT,
PRIMARY KEY(`id`)
);
```

**Listings table**
```{sql connection='mariacon'}
CREATE TABLE IF NOT EXISTS `Listings`
(
`list_id` INT NOT NULL AUTO_INCREMENT,
`comp_id` INT NOT NULL,
`level` VARCHAR(50),
`title` VARCHAR(50),  -- had to ALTER this to 250 later to fit some atlanta listings
`keywords` VARCHAR(250),
`minYears` INT,
`niceYears` INT,
`degree` INT,
`STEM` INT,
`city` VARCHAR(50),
`state` VARCHAR(50),
`minSal` INT,
`maxSal` INT,
PRIMARY KEY(`list_id`),
FOREIGN KEY(`comp_id`) REFERENCES Companies(`id`) ON DELETE CASCADE,
FOREIGN KEY(`degree`) REFERENCES Degrees(`degreeLevel`) ON DELETE SET NULL
);

```

**ListingSkill table**
```{sql connection='mariacon'}
CREATE TABLE IF NOT EXISTS `ListingSkill`
(
`listing` INT NOT NULL,
`skill` VARCHAR(50) NOT NULL,
FOREIGN KEY(`listing`) REFERENCES Listings(`list_id`),
FOREIGN KEY(`skill`) REFERENCES Skills(`code`)
);

```

```{sql connection='mariacon'}
ALTER TABLE Listings MODIFY keywords VARCHAR(250);
```


### Now the schema is set and the rows need to be added.
##### Change the table col names to match database schema, in case of issues
```{r}
names(skills) <- c('code', 'meaning')
names(degrees) <- c('degreeLevel', 'meaning')
names(companies) <- c('name', 'numEmpls', 'id')
# rearrange cols to match db schema
companies <- companies[c('id', 'name', 'numEmpls')]
names(listings) <- c('list_id', 'comp_id', 'level', 'title', 'keywords',
                     'minYears', 'niceYears', 'degree', 'STEM',
                     'city', 'state', 'minSal', 'maxSal')

# listingskill table is already named properly
```

### Attempt to add the tables into the empty database tables  

```{r}
dbWriteTable(mariacon, "Skills", skills, append=T)
dbWriteTable(mariacon, "Degrees", degrees, append=T)
dbWriteTable(mariacon, 'Companies', companies, append=T)
dbWriteTable(mariacon, "Listings", listings, append=T)
dbWriteTable(mariacon, "ListingSkill", table, append=T) #THIS WAS BROKEN (see below)
```

#### The ListingSkill table doesn't populate, maybe because there are dupes
**De-dupe and try again**

```{r}
skillList <- distinct(table)
dbWriteTable(mariacon, "ListingSkill", skillList, append=T)
```

```{r}
skillList[1:3,]
```


#### That wasn't the problem, or at least not all the problems.  
##### Maybe one of the skill keys just isn't matching the one in the Skill table.

```{r}
print(head(skillList, 2))
print(head(skills, 2))
```

#### Go through each skillList code and make sure it's in the skills codes
```{r}
for (sk in skillList$skill) {
  if (! sk %in% skills$code) {
    print(sk)
  }
}
```

#### So we need to add ('CV','Computer Vision') to the Skill table and remove
####  leading whitespace from the five other rows in skillList  

```{sql connection='mariacon'}
INSERT INTO Skills (code, meaning) VALUES ('CV', 'Computer Vision');
```

```{r}
trimmed <- unlist(map(skillList$skill, str_trim))
skillList$skill <- trimmed
```

Now try again  

```{r}
dbWriteTable(mariacon, "ListingSkill", skillList, append=T)
```

# Get Sean's data table in here, to append/prepend  

```{r}
seanurl <- 'https://raw.githubusercontent.com/zachsfr/Data-607-Project-Three/Sean-Branch/Atlanta_Clean.csv'
atl <- read_csv(seanurl)
head(atl)
```
## Start with the easy one, adding companies

```{r}
atl_cos <- unique(atl$Company)
length(atl_cos)
atl_cos[1:5]
# remove the NA
atl_cos <- atl_cos[2:length(atl_cos)]
new_cos <- c()  # store new cos as we iterate over atl_cos
# here's one list of existing companies, from earlier:
## companies <- companies[c('id', 'name', 'numEmpls')]
for (co in atl_cos) {
  if (! (co %in% companies$id)) {
    new_cos <- c(new_cos, co)
  }
}
length(atl_cos) - length(new_cos) # how many companies already existed
```
### so there were 5 companies in already, and the rest are new and can be added now  

```{r}
# The existing companies in the db are numbered 1-40, so start numbering there
##  We'll just use 0 for numEmpls in the append, which we can update later if we want
newco_df <- data.frame('id' = c(41:(40+length(new_cos))), 
                       'name' = new_cos,
                       'numEmpls' = rep(0, length(new_cos)))
newco_df
```
### append that to the db table  

```{r}
dbWriteTable(mariacon, 'Companies', newco_df, append=T)
```

# Onto the Listings now...  

```{r}
#  for reference:  names(listings) <- c('list_id', 'comp_id', 'level', 'title', 'keywords',
#                     'minYears', 'niceYears', 'degree', 'STEM',
#                    'city', 'state', 'minSal', 'maxSal')
#### Highest list_id so far is 42
# remove that first NA row
atl <- atl[-1,]
patch_ids <- c(43:(42 + nrow(atl)))
# now convert company names to id's
allcomps <- dbReadTable(mariacon, 'Companies')
head(allcomps)
```
```{r}
complist <- list('names' = allcomps$name, 'ids' = allcomps$id)
patch_comp_ids <- match(atl$Company, complist$names)
patch_comp_ids
```

### next up: job level  

```{r}
patch_levels <- atl$Job_Level
length(patch_levels)
```

### That was a nice gimme.  Now onto job titles:  

```{r}
patch_titles <- atl$Job_Title
length(patch_titles)
```

### On a roll.  Most of what's left is nulls.  

```{r}
# in order: 'keywords','minYears', 'niceYears', 'degree', 'STEM','city', 'state', 'minSal', 'maxSal'
patch_keywords <- rep('',150)
patch_minyrs <- rep(0, 150)
patch_niceyrs <- rep(0, 150)
patch_degree <- rep(0, 150)
patch_stem <- rep(-1, 150)
patch_city <- atl$City
patch_state <- atl$State
patch_minsal <- rep(0, 150)
patch_maxsal <- rep(0, 150)
```

## Stack everything up in a box and patch it on to the db table  

```{r}
patch_box <- data.frame('list_id' = patch_ids,
                        'comp_id' = patch_comp_ids,
                        'level' = patch_levels,
                        'title' = patch_titles,
                        'keywords' = patch_keywords,
                        'minYears' = patch_minyrs,
                        'niceYears' = patch_niceyrs,
                        'degree' = patch_degree,
                        'STEM' = patch_stem,
                        'city' = patch_city,
                        'state' = patch_state,
                        'minSal' = patch_minsal,
                        'maxSal' = patch_maxsal)
dim(patch_box)
```

```{r}
#dbWriteTable(mariacon, 'Listings', patch_box, append=T)
```
```{r}
patch_titles
```

```{sql connection='mariacon'}
ALTER TABLE Listings MODIFY title VARCHAR(250);
```

```{r}
dbWriteTable(mariacon, 'Listings', patch_box, append=T)
```

# Last step is to append to the ListingSkill db table  
**This entails loading the atlanta skills matrix and using non-zero pairs  

```{r}
atl_skills <- read_excel('~/Downloads/danielSkills.xlsx')
head(atl_skills)
```
#### Just keep the first and last columns, to be able to map phrases Daniel used
#### to build a listing/term matrix, where the term will be the 'shortform' col
#### here and we'll map it to the 'code' col here to populate ListingSkill table.  

```{r}
atl_skills <- atl_skills[c('shortform', 'code')]
dim(atl_skills)
```

Make sure all codes are already in the Skills table

```{r}
oldskills <- dbReadTable(mariacon, 'Skills')
for (c in atl_skills$code) {
  if (! c %in% oldskills$code) {
    print(c)
  }
}
```

```{sql connection='mariacon'}
INSERT INTO Skills (code, meaning) VALUES ('AI', 'Artificial Intelligence'),
                                          ('CM', 'Communication');
```

### load atl_listing_skills from atl_skill_matrix.Rmd  

```{r}
atl_list_skills <- read_csv('atl_listing_skills.csv')
head(atl_list_skills)
```

```{r}
sum(is.na(atl_list_skills$listing_id))
```


### Now map those terms to codes and it can be merged to db  

```{r}
dim(atl_list_skills)
```
```{r}
merged <- merge(atl_list_skills, atl_skills, by.x = 'term', by.y = 'shortform')
merged
```
### note: lost 5% of rows there, but worry about that some other day  

```{r}
patch_box <- data.frame('listing' = merged$listing_id, 'skill' = merged$code)
dbWriteTable(mariacon, 'ListingSkill', patch_box, append=T)
```


### Add 'communicating' from non-atlanta 'keywords' column into 'CM' in the
##### ListingSkill table  

```{r}
LS <- dbReadTable(mariacon, 'Listings')
```

```{r}
comm_ids <- c()
for (i in 1:42) {
  if ('communicating' %in% str_match(LS$keywords[i], 'communicating')) {
    comm_ids <- c(comm_ids, LS$list_id[i])
  }
}
cms <- rep('CM', length(comm_ids))
patch_box <- data.frame('listing' = comm_ids, 'skill' = cms)
dbWriteTable(mariacon, 'ListingSkill', patch_box, append=T)
```

```{r}
dbDisconnect(mariacon)
```